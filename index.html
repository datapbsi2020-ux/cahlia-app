<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ujian Online</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel untuk JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Running Text Animation */
        .marquee-container { overflow: hidden; white-space: nowrap; position: relative; }
        .marquee-text { display: inline-block; padding-left: 100%; animation: marquee 20s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* Print Styles */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white !important; color: black; }
            .print-container { padding: 0; width: 100%; }
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid black; padding: 8px; }
            
            /* Break page for bulk printing if needed */
            .page-break { page-break-after: always; }
        }
        .print-only { display: none; }
        
        /* Background App Wrapper */
        .app-bg {
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- DATA DEFAULTS ---
        const DEFAULT_SETTINGS = {
            appName: 'SMP NEGERI 1 ARAHAN',
            appBg: '', // URL Background
            currentAcademicYear: '2025/2026 Ganjil'
        };

        const ACADEMIC_YEARS = [
            '2025/2026 Ganjil', '2025/2026 Genap',
            '2026/2027 Ganjil', '2026/2027 Genap',
            '2027/2028 Ganjil', '2027/2028 Genap',
            '2028/2029 Ganjil', '2028/2029 Genap',
            '2029/2030 Ganjil', '2029/2030 Genap'
        ];

        const DEFAULT_TEACHERS = [
            { id: 1, name: 'Bpk. Budi Santoso', username: 'guru1', password: '123', photo: null }
        ];

        const DEFAULT_STUDENTS = [
            { id: 1, name: 'Siswa Contoh', nim: '12345', username: 'siswa', password: '123', className: '9A', subject: 'Matematika' }
        ];

        const DEFAULT_SUBJECTS = [
            { id: 1, name: 'Matematika', teacher: 'Bpk. Budi Santoso' }
        ];

        const DEFAULT_EXAMS = []; 

        // --- LOGIN COMPONENT ---
        const LoginView = ({ handleLogin, loginInput, setLoginInput, settings }) => (
            <div className="min-h-screen flex flex-col bg-gray-100 app-bg" style={{ backgroundImage: settings.appBg ? `url(${settings.appBg})` : 'none' }}>
                <div className="bg-blue-900 text-white py-3 shadow-md marquee-container no-print bg-opacity-90">
                    <span className="marquee-text font-bold text-lg">
                        SELAMAT DATANG DI APLIKASI UJIAN ONLINE {settings.appName} â€” PERIODE {settings.currentAcademicYear}
                    </span>
                </div>

                <div className="flex-grow flex items-center justify-center p-4 no-print">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md border-t-4 border-blue-600 fade-in bg-opacity-95 backdrop-blur-sm">
                        <div className="text-center mb-8">
                            <div className="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i className="fas fa-school text-4xl text-blue-600"></i>
                            </div>
                            <h2 className="text-2xl font-bold text-gray-800">Login Aplikasi</h2>
                            <p className="text-gray-500 text-sm">{settings.appName}</p>
                        </div>

                        <form onSubmit={handleLogin} className="space-y-5">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                <div className="relative">
                                    <input 
                                        type="text" 
                                        required
                                        className="w-full border p-3 pl-10 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition"
                                        value={loginInput.username}
                                        onChange={(e) => setLoginInput({...loginInput, username: e.target.value})}
                                        placeholder="Masukkan username..."
                                    />
                                    <i className="fas fa-user absolute left-3 top-3.5 text-gray-400"></i>
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <div className="relative">
                                    <input 
                                        type="password" 
                                        required
                                        className="w-full border p-3 pl-10 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition"
                                        value={loginInput.password}
                                        onChange={(e) => setLoginInput({...loginInput, password: e.target.value})}
                                        placeholder="Masukkan password..."
                                    />
                                    <i className="fas fa-lock absolute left-3 top-3.5 text-gray-400"></i>
                                </div>
                            </div>
                            <button className="w-full bg-blue-700 text-white py-3 rounded-lg font-bold hover:bg-blue-800 transition shadow-lg">
                                MASUK
                            </button>
                        </form>
                    </div>
                </div>
                <footer className="text-center py-4 text-gray-600 text-sm no-print bg-white bg-opacity-80">
                    &copy; 2026 {settings.appName}
                </footer>
            </div>
        );

        // --- COMPONENT: TEACHER DASHBOARD ---
        const TeacherDashboard = ({ user, setUser, teachers, setTeachers, exams, setExams, results, handleLogout, settings }) => {
            const [activeTab, setActiveTab] = useState('pts');
            const [editingExamId, setEditingExamId] = useState(null);
            const [newPass, setNewPass] = useState('');

            const myExams = exams.filter(e => e.teacher === user.name && e.category === activeTab);
            
            // Added className to state
            const [newExam, setNewExam] = useState({ subject: '', className: '', date: '', start: '', end: '', academicYear: settings.currentAcademicYear });
            const [newQuestion, setNewQuestion] = useState({ type: 'multiple_choice', question: '', options: ['', '', '', ''], correctAnswer: '', points: 10 });

            // Photo Upload Handler
            const handlePhotoUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const newPhoto = reader.result;
                        const updatedTeachers = teachers.map(t => t.id === user.id ? { ...t, photo: newPhoto } : t);
                        setTeachers(updatedTeachers);
                        setUser({ ...user, photo: newPhoto });
                    };
                    reader.readAsDataURL(file);
                }
            };

            const createExam = () => {
                if(!newExam.subject || !newExam.className || !newExam.date || !newExam.start || !newExam.end) return alert("Lengkapi data jadwal (termasuk kelas).");
                const examPacket = {
                    id: Date.now(),
                    category: activeTab,
                    subject: newExam.subject,
                    className: newExam.className, 
                    teacher: user.name,
                    date: newExam.date,
                    start: newExam.start,
                    end: newExam.end,
                    academicYear: newExam.academicYear,
                    questions: []
                };
                setExams([...exams, examPacket]);
                setNewExam({ ...newExam, subject: '', className: '', date: '', start: '', end: '' });
                alert("Jadwal berhasil dibuat.");
            };

            const changePassword = () => {
                if(!newPass) return alert("Password tidak boleh kosong");
                const updatedTeachers = teachers.map(t => t.id === user.id ? { ...t, password: newPass } : t);
                setTeachers(updatedTeachers);
                setUser({ ...user, password: newPass });
                alert("Password berhasil diubah");
                setNewPass('');
            };

            const deleteExam = (id) => { if(confirm("Hapus ujian ini?")) setExams(exams.filter(e => e.id !== id)); };
            const addQuestionToExam = () => {
                if(!editingExamId || !newQuestion.question) return;
                const updatedExams = exams.map(exam => {
                    if(exam.id === editingExamId) return { ...exam, questions: [...exam.questions, { ...newQuestion, id: Date.now() }] };
                    return exam;
                });
                setExams(updatedExams);
                setNewQuestion({ type: 'multiple_choice', question: '', options: ['', '', '', ''], correctAnswer: '', points: 10 });
            };
            const deleteQuestion = (examId, qId) => {
                const updatedExams = exams.map(exam => {
                    if(exam.id === examId) return { ...exam, questions: exam.questions.filter(q => q.id !== qId) };
                    return exam;
                });
                setExams(updatedExams);
            };

            return (
                <div className="min-h-screen flex bg-gray-50">
                     <div className="w-64 bg-teal-800 text-white flex flex-col shadow-xl fixed h-full overflow-y-auto no-print z-20">
                        <div className="p-6 text-center border-b border-teal-700 flex flex-col items-center">
                            <div className="w-20 h-20 rounded-full bg-teal-600 mb-3 border-4 border-teal-500 overflow-hidden flex items-center justify-center">
                                {user.photo ? (
                                    <img src={user.photo} alt="Profil" className="w-full h-full object-cover" />
                                ) : (
                                    <i className="fas fa-user text-4xl text-teal-300"></i>
                                )}
                            </div>
                            <h2 className="text-lg font-bold">{user.name}</h2>
                            <p className="text-teal-300 text-xs">Guru</p>
                        </div>
                        <nav className="flex-grow p-4 space-y-2">
                            <button onClick={() => setActiveTab('profile')} className={`w-full text-left p-3 rounded flex items-center gap-3 transition ${activeTab === 'profile' ? 'bg-teal-600 shadow' : 'hover:bg-teal-700'}`}>
                                <i className="fas fa-user-circle w-6"></i> Profil Saya
                            </button>
                            <button onClick={() => setActiveTab('pts')} className={`w-full text-left p-3 rounded flex items-center gap-3 transition ${activeTab === 'pts' ? 'bg-teal-600 shadow' : 'hover:bg-teal-700'}`}>
                                <i className="fas fa-file-alt w-6"></i> PTS
                            </button>
                            <button onClick={() => setActiveTab('pas')} className={`w-full text-left p-3 rounded flex items-center gap-3 transition ${activeTab === 'pas' ? 'bg-teal-600 shadow' : 'hover:bg-teal-700'}`}>
                                <i className="fas fa-graduation-cap w-6"></i> PAS
                            </button>
                            <button onClick={() => setActiveTab('results')} className={`w-full text-left p-3 rounded flex items-center gap-3 transition ${activeTab === 'results' ? 'bg-teal-600 shadow' : 'hover:bg-teal-700'}`}>
                                <i className="fas fa-chart-bar w-6"></i> Hasil Ujian
                            </button>
                        </nav>
                        <div className="p-4 border-t border-teal-700 space-y-2">
                            <button onClick={handleLogout} className="w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded flex items-center justify-center gap-2 transition">
                                <i className="fas fa-sign-out-alt"></i> Keluar
                            </button>
                        </div>
                    </div>

                    <div className="flex-grow p-8 ml-64 overflow-y-auto min-h-screen">
                        
                        {activeTab === 'profile' && (
                            <div className="space-y-6 fade-in no-print">
                                <h2 className="text-2xl font-bold text-gray-800 border-b pb-2">Profil Guru</h2>
                                <div className="bg-white p-6 rounded-lg shadow-sm border max-w-2xl">
                                    <div className="flex items-center gap-6 mb-6">
                                        <div className="w-24 h-24 rounded-full bg-gray-200 overflow-hidden flex-shrink-0 border-2 border-teal-500">
                                            {user.photo ? (
                                                <img src={user.photo} alt="Profil" className="w-full h-full object-cover" />
                                            ) : (
                                                <div className="w-full h-full flex items-center justify-center text-gray-400"><i className="fas fa-user text-4xl"></i></div>
                                            )}
                                        </div>
                                        <div>
                                            <h3 className="text-xl font-bold">{user.name}</h3>
                                            <p className="text-gray-500">Username: {user.username}</p>
                                            <label className="block mt-3">
                                                <span className="bg-teal-600 text-white text-xs px-3 py-1 rounded cursor-pointer hover:bg-teal-700">Upload Foto</span>
                                                <input type="file" className="hidden" accept="image/*" onChange={handlePhotoUpload} />
                                            </label>
                                        </div>
                                    </div>
                                    <hr className="my-4"/>
                                    <h4 className="font-bold text-gray-700 mb-2">Ganti Password</h4>
                                    <div className="flex gap-2">
                                        <input type="password" value={newPass} onChange={e => setNewPass(e.target.value)} className="border p-2 rounded w-full" placeholder="Password Baru" />
                                        <button onClick={changePassword} className="bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700">Simpan</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {(activeTab === 'pts' || activeTab === 'pas') && (
                            <div className="space-y-8 fade-in no-print">
                                <h2 className="text-2xl font-bold text-gray-800 border-b pb-2 uppercase">Kelola {activeTab}</h2>
                                
                                <div className="bg-white p-6 rounded-lg shadow-sm border space-y-4">
                                    <h3 className="font-bold text-teal-700">Buat Jadwal Baru</h3>
                                    <div className="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-xs font-bold text-gray-500">Mata Pelajaran</label>
                                            <input className="border p-2 rounded w-full" value={newExam.subject} onChange={e => setNewExam({...newExam, subject: e.target.value})} placeholder="Contoh: IPA" />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-gray-500">Target Kelas</label>
                                            <input className="border p-2 rounded w-full" value={newExam.className} onChange={e => setNewExam({...newExam, className: e.target.value})} placeholder="Contoh: 9A, 7B" />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-gray-500">Tahun Akademik</label>
                                            <select className="border p-2 rounded w-full" value={newExam.academicYear} onChange={e => setNewExam({...newExam, academicYear: e.target.value})}>
                                                {ACADEMIC_YEARS.map(yr => <option key={yr} value={yr}>{yr}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-gray-500">Tanggal</label>
                                            <input type="date" className="border p-2 rounded w-full" value={newExam.date} onChange={e => setNewExam({...newExam, date: e.target.value})} />
                                        </div>
                                        <div className="flex gap-2">
                                            <div className="flex-1">
                                                <label className="text-xs font-bold text-gray-500">Mulai</label>
                                                <input type="time" className="border p-2 rounded w-full" value={newExam.start} onChange={e => setNewExam({...newExam, start: e.target.value})} />
                                            </div>
                                            <div className="flex-1">
                                                <label className="text-xs font-bold text-gray-500">Selesai</label>
                                                <input type="time" className="border p-2 rounded w-full" value={newExam.end} onChange={e => setNewExam({...newExam, end: e.target.value})} />
                                            </div>
                                        </div>
                                    </div>
                                    <button onClick={createExam} className="bg-teal-600 text-white px-4 py-2 rounded font-bold hover:bg-teal-700">Buat Jadwal</button>
                                </div>

                                <div className="space-y-4">
                                    {myExams.map(exam => (
                                        <div key={exam.id} className={`bg-white border rounded-xl overflow-hidden shadow-sm ${editingExamId === exam.id ? 'ring-2 ring-teal-500' : ''}`}>
                                            <div className="p-4 bg-gray-50 flex justify-between items-center">
                                                <div>
                                                    <h3 className="font-bold text-lg">{exam.subject} <span className="bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded ml-2">Kelas {exam.className}</span></h3>
                                                    <p className="text-xs text-gray-500 mt-1">{exam.date} | {exam.start} - {exam.end}</p>
                                                    <span className="text-xs font-bold text-blue-600">{exam.questions.length} Soal</span>
                                                </div>
                                                <div className="flex gap-2">
                                                    <button onClick={() => setEditingExamId(editingExamId === exam.id ? null : exam.id)} className="px-3 py-1 bg-white border text-teal-600 rounded hover:bg-teal-50">
                                                        {editingExamId === exam.id ? 'Tutup' : 'Isi Soal'}
                                                    </button>
                                                    <button onClick={() => deleteExam(exam.id)} className="px-3 py-1 bg-red-100 text-red-600 rounded hover:bg-red-200"><i className="fas fa-trash"></i></button>
                                                </div>
                                            </div>

                                            {editingExamId === exam.id && (
                                                <div className="p-6 border-t bg-white">
                                                    <div className="bg-teal-50 p-4 rounded-lg mb-6 border border-teal-100">
                                                        <div className="flex gap-4 mb-3">
                                                            <select className="border p-2 rounded" value={newQuestion.type} onChange={e => setNewQuestion({...newQuestion, type: e.target.value})}>
                                                                <option value="multiple_choice">Pilihan Ganda</option>
                                                                <option value="essay">Essay</option>
                                                            </select>
                                                            <input type="number" className="border p-2 rounded w-24" placeholder="Poin" value={newQuestion.points} onChange={e => setNewQuestion({...newQuestion, points: e.target.value})} />
                                                        </div>
                                                        <textarea className="w-full border p-2 rounded mb-3" rows="2" placeholder="Pertanyaan..." value={newQuestion.question} onChange={e => setNewQuestion({...newQuestion, question: e.target.value})}></textarea>
                                                        {newQuestion.type === 'multiple_choice' && (
                                                            <div className="grid grid-cols-2 gap-3 mb-3">
                                                                {newQuestion.options.map((opt, i) => (
                                                                    <input key={i} className="border p-2 rounded text-sm" placeholder={`Opsi ${i+1}`} value={opt} onChange={e => {
                                                                        const newOpts = [...newQuestion.options];
                                                                        newOpts[i] = e.target.value;
                                                                        setNewQuestion({...newQuestion, options: newOpts});
                                                                    }} />
                                                                ))}
                                                                <select className="col-span-2 border p-2 rounded text-sm" value={newQuestion.correctAnswer} onChange={e => setNewQuestion({...newQuestion, correctAnswer: e.target.value})}>
                                                                    <option value="">Kunci Jawaban</option>
                                                                    {newQuestion.options.map((o, i) => o && <option key={i} value={o}>{o}</option>)}
                                                                </select>
                                                            </div>
                                                        )}
                                                        <button onClick={addQuestionToExam} className="bg-teal-600 text-white px-4 py-2 rounded text-sm w-full hover:bg-teal-700">Simpan Soal</button>
                                                    </div>
                                                    <div className="space-y-2">
                                                        {exam.questions.map((q, idx) => (
                                                            <div key={q.id} className="border p-2 rounded flex justify-between">
                                                                <div><span className="font-bold mr-2">#{idx+1}</span><span>{q.question}</span></div>
                                                                <button onClick={() => deleteQuestion(exam.id, q.id)} className="text-red-500 text-xs">Hapus</button>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'results' && <ResultsView results={results} exams={exams} teacherFilter={user.name} settings={settings} />}
                    </div>
                </div>
            );
        };

        // --- ADMIN DASHBOARD ---
        const AdminDashboard = ({ 
            students, setStudents, 
            teachers, setTeachers,
            subjects, setSubjects,
            exams, setExams,
            results, handleLogout,
            settings, setSettings
        }) => {
            const [activeTab, setActiveTab] = useState('students');
            
            const [newStudent, setNewStudent] = useState({ name: '', nim: '', username: '', password: '', className: '', subject: '' });
            const [newTeacher, setNewTeacher] = useState({ name: '', username: '', password: '' });
            const [importText, setImportText] = useState('');
            const [showImport, setShowImport] = useState(false);
            const [importMode, setImportMode] = useState('student'); 

            // --- SETTINGS LOGIC ---
            const updateSettings = (key, val) => setSettings({ ...settings, [key]: val });

            // --- IMPORT LOGIC ---
            const handleImport = () => {
                const lines = importText.trim().split('\n');
                let count = 0;
                
                if (importMode === 'student') {
                    const imported = lines.map((line, idx) => {
                        let parts = line.split('\t');
                        if (parts.length < 3) parts = line.split(','); 
                        if (parts.length >= 3) {
                            return { 
                                id: Date.now() + idx, 
                                name: parts[0]?.trim(), 
                                nim: parts[1]?.trim(), 
                                username: parts[2]?.trim(), 
                                password: parts[3]?.trim() || parts[1]?.trim(), 
                                className: parts[4]?.trim() || '-',
                                subject: parts[5]?.trim() || '-'
                            };
                        }
                        return null;
                    }).filter(Boolean);
                    if(imported.length > 0) {
                        setStudents([...students, ...imported]);
                        count = imported.length;
                    }
                } else {
                    const imported = lines.map((line, idx) => {
                        let parts = line.split('\t');
                        if (parts.length < 3) parts = line.split(',');
                        if (parts.length >= 3) {
                            return {
                                id: Date.now() + idx,
                                name: parts[0]?.trim(),
                                username: parts[1]?.trim(),
                                password: parts[2]?.trim(),
                                photo: null // Default null for imported teachers
                            };
                        }
                        return null;
                    }).filter(Boolean);
                    if(imported.length > 0) {
                        setTeachers([...teachers, ...imported]);
                        count = imported.length;
                    }
                }
                
                setImportText('');
                setShowImport(false);
                alert(`Berhasil import ${count} data.`);
            };

            const addStudent = () => {
                setStudents([...students, { ...newStudent, id: Date.now() }]);
                setNewStudent({ name: '', nim: '', username: '', password: '', className: '', subject: '' });
            };
            
            const addTeacher = () => {
                setTeachers([...teachers, { ...newTeacher, id: Date.now() }]);
                setNewTeacher({ name: '', username: '', password: '' });
            };

            const deleteItem = (setList, list, id) => setList(list.filter(item => item.id !== id));
            
            const updateTeacher = (id, field, val) => {
                setTeachers(teachers.map(t => t.id === id ? { ...t, [field]: val } : t));
            };

            return (
                <div className="min-h-screen flex bg-gray-50">
                    <div className="w-64 bg-slate-900 text-white flex flex-col shadow-xl fixed h-full overflow-y-auto no-print z-20">
                        <div className="p-6 text-center border-b border-slate-700">
                            <h2 className="text-xl font-bold">Admin Panel</h2>
                            <p className="text-slate-400 text-xs mt-1">{settings.appName}</p>
                        </div>
                        <nav className="flex-grow p-4 space-y-2">
                            <button onClick={() => setActiveTab('settings')} className={`w-full text-left p-3 rounded flex items-center gap-3 transition ${activeTab === 'settings' ? 'bg-blue-600 shadow' : 'hover:bg-slate-800'}`}>
                                <i className="fas fa-cogs w-6"></i> Pengaturan
                            </button>
                            <button onClick={() => setActiveTab('students')} className={`w-full text-left p-3 rounded flex items-center gap-3 transition ${activeTab === 'students' ? 'bg-blue-600 shadow' : 'hover:bg-slate-800'}`}>
                                <i className="fas fa-users w-6"></i> Data Siswa
                            </button>
                            <button onClick={() => setActiveTab('teachers')} className={`w-full text-left p-3 rounded flex items-center gap-3 transition ${activeTab === 'teachers' ? 'bg-blue-600 shadow' : 'hover:bg-slate-800'}`}>
                                <i className="fas fa-chalkboard-teacher w-6"></i> Data Guru
                            </button>
                            <button onClick={() => setActiveTab('results')} className={`w-full text-left p-3 rounded flex items-center gap-3 transition ${activeTab === 'results' ? 'bg-blue-600 shadow' : 'hover:bg-slate-800'}`}>
                                <i className="fas fa-chart-bar w-6"></i> Hasil Ujian
                            </button>
                        </nav>
                        <div className="p-4 border-t border-slate-700">
                            <button onClick={handleLogout} className="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded flex items-center justify-center gap-2 transition">
                                <i className="fas fa-sign-out-alt"></i> Keluar
                            </button>
                        </div>
                    </div>

                    <div className="flex-grow p-8 ml-64 overflow-y-auto min-h-screen">
                        {activeTab === 'settings' && (
                            <div className="space-y-6 fade-in no-print">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Pengaturan Aplikasi</h2>
                                <div className="bg-white p-6 rounded-lg shadow-sm border space-y-4 max-w-2xl">
                                    <div>
                                        <label className="block text-sm font-bold text-gray-600 mb-1">Nama Aplikasi / Sekolah</label>
                                        <input className="w-full border p-2 rounded" value={settings.appName} onChange={e => updateSettings('appName', e.target.value)} />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-600 mb-1">URL Gambar Latar Belakang</label>
                                        <input className="w-full border p-2 rounded" value={settings.appBg} onChange={e => updateSettings('appBg', e.target.value)} placeholder="https://example.com/image.jpg" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-600 mb-1">Periode Akademik Aktif (Backup/Filter)</label>
                                        <select className="w-full border p-2 rounded" value={settings.currentAcademicYear} onChange={e => updateSettings('currentAcademicYear', e.target.value)}>
                                            {ACADEMIC_YEARS.map(yr => <option key={yr} value={yr}>{yr}</option>)}
                                        </select>
                                    </div>
                                    <div className="bg-blue-50 p-3 rounded text-sm text-blue-800">
                                        Pengaturan ini akan tersimpan otomatis dan mempengaruhi tampilan Login serta filter data.
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'students' && (
                            <div className="space-y-6 fade-in no-print">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Manajemen Data Siswa</h2>
                                <div className="bg-white p-6 rounded-lg shadow-sm border">
                                    <div className="grid md:grid-cols-6 gap-2 mb-4">
                                        <input className="border p-2 rounded text-sm" placeholder="Nama" value={newStudent.name} onChange={e => setNewStudent({...newStudent, name: e.target.value})} />
                                        <input className="border p-2 rounded text-sm" placeholder="NIS" value={newStudent.nim} onChange={e => setNewStudent({...newStudent, nim: e.target.value})} />
                                        <input className="border p-2 rounded text-sm" placeholder="Username" value={newStudent.username} onChange={e => setNewStudent({...newStudent, username: e.target.value})} />
                                        <input className="border p-2 rounded text-sm" placeholder="Password" value={newStudent.password} onChange={e => setNewStudent({...newStudent, password: e.target.value})} />
                                        <input className="border p-2 rounded text-sm" placeholder="Kelas (ex: 9A)" value={newStudent.className} onChange={e => setNewStudent({...newStudent, className: e.target.value})} />
                                        <input className="border p-2 rounded text-sm" placeholder="Mapel (Opsional)" value={newStudent.subject} onChange={e => setNewStudent({...newStudent, subject: e.target.value})} />
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={addStudent} className="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">Simpan Manual</button>
                                        <button onClick={() => { setImportMode('student'); setShowImport(!showImport); }} className="bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700"><i className="fas fa-file-excel"></i> Import Excel</button>
                                    </div>
                                </div>
                                {showImport && importMode === 'student' && (
                                    <div className="bg-green-50 p-4 rounded border border-green-200">
                                        <p className="text-xs font-bold text-green-800 mb-2">Format: Nama | NIS | Username | Password | Kelas | Mapel</p>
                                        <textarea className="w-full border p-2 text-xs h-24" value={importText} onChange={e => setImportText(e.target.value)} placeholder="Paste data Excel disini..."></textarea>
                                        <button onClick={handleImport} className="bg-green-700 text-white px-4 py-1 rounded text-sm mt-2">Proses Import</button>
                                    </div>
                                )}
                                <div className="bg-white rounded-lg shadow-sm border overflow-hidden">
                                    <table className="w-full text-left text-sm">
                                        <thead className="bg-slate-100 uppercase font-bold">
                                            <tr><th className="p-3">Nama</th><th className="p-3">NIS</th><th className="p-3">Kelas</th><th className="p-3">Mapel</th><th className="p-3">User/Pass</th><th className="p-3">Aksi</th></tr>
                                        </thead>
                                        <tbody>
                                            {students.map(s => (
                                                <tr key={s.id} className="border-t hover:bg-slate-50">
                                                    <td className="p-3">{s.name}</td>
                                                    <td className="p-3">{s.nim}</td>
                                                    <td className="p-3"><span className="bg-yellow-100 px-2 rounded text-xs font-bold">{s.className}</span></td>
                                                    <td className="p-3">{s.subject}</td>
                                                    <td className="p-3 font-mono text-xs">{s.username} / {s.password}</td>
                                                    <td className="p-3"><button onClick={() => deleteItem(setStudents, students, s.id)} className="text-red-500"><i className="fas fa-trash"></i></button></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'teachers' && (
                            <div className="space-y-6 fade-in no-print">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Manajemen Data Guru</h2>
                                <div className="bg-white p-6 rounded-lg shadow-sm border flex gap-2 mb-4">
                                    <input className="border p-2 rounded text-sm flex-1" placeholder="Nama Guru" value={newTeacher.name} onChange={e => setNewTeacher({...newTeacher, name: e.target.value})} />
                                    <input className="border p-2 rounded text-sm flex-1" placeholder="Username" value={newTeacher.username} onChange={e => setNewTeacher({...newTeacher, username: e.target.value})} />
                                    <input className="border p-2 rounded text-sm flex-1" placeholder="Password" value={newTeacher.password} onChange={e => setNewTeacher({...newTeacher, password: e.target.value})} />
                                    <button onClick={addTeacher} className="bg-blue-600 text-white px-4 py-2 rounded text-sm">Tambah</button>
                                    <button onClick={() => { setImportMode('teacher'); setShowImport(!showImport); }} className="bg-green-600 text-white px-4 py-2 rounded text-sm"><i className="fas fa-file-excel"></i> Import</button>
                                </div>
                                {showImport && importMode === 'teacher' && (
                                    <div className="bg-green-50 p-4 rounded border border-green-200 mb-4">
                                        <p className="text-xs font-bold text-green-800 mb-2">Format: Nama | Username | Password</p>
                                        <textarea className="w-full border p-2 text-xs h-24" value={importText} onChange={e => setImportText(e.target.value)} placeholder="Paste data Excel disini..."></textarea>
                                        <button onClick={handleImport} className="bg-green-700 text-white px-4 py-1 rounded text-sm mt-2">Proses Import</button>
                                    </div>
                                )}
                                <div className="bg-white rounded-lg shadow-sm border overflow-hidden">
                                    <table className="w-full text-left text-sm">
                                        <thead className="bg-slate-100 uppercase font-bold">
                                            <tr><th className="p-3">Nama</th><th className="p-3">Username</th><th className="p-3">Password</th><th className="p-3">Aksi</th></tr>
                                        </thead>
                                        <tbody>
                                            {teachers.map(t => (
                                                <tr key={t.id} className="border-t hover:bg-slate-50">
                                                    <td className="p-3">{t.name}</td>
                                                    <td className="p-3">{t.username}</td>
                                                    <td className="p-3">
                                                        <input className="border p-1 rounded text-xs w-24" value={t.password} onChange={(e) => updateTeacher(t.id, 'password', e.target.value)} />
                                                    </td>
                                                    <td className="p-3"><button onClick={() => deleteItem(setTeachers, teachers, t.id)} className="text-red-500"><i className="fas fa-trash"></i></button></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'results' && <ResultsView results={results} exams={exams} settings={settings} />}
                    </div>
                </div>
            );
        };

        const ResultsView = ({ results, exams, teacherFilter = null, settings }) => {
            const [filterCategory, setFilterCategory] = useState('all');
            const [viewMode, setViewMode] = useState('table'); // table, detail
            const [selectedResult, setSelectedResult] = useState(null);

            const filteredResults = results.filter(r => {
                const matchTeacher = teacherFilter ? r.teacher === teacherFilter : true;
                const matchCat = filterCategory === 'all' ? true : r.category === filterCategory;
                const matchYear = r.academicYear === settings.currentAcademicYear; 
                return matchTeacher && matchCat && matchYear;
            });

            // Find full exam data for detail view
            const selectedExam = selectedResult ? exams.find(e => e.id === selectedResult.examId) : null;

            if (viewMode === 'detail' && selectedResult && selectedExam) {
                return (
                    <div className="space-in fade-in">
                        <div className="flex justify-between items-center mb-6 no-print">
                            <button onClick={() => setViewMode('table')} className="bg-white border px-4 py-2 rounded shadow hover:bg-gray-100 flex items-center gap-2">
                                <i className="fas fa-arrow-left"></i> Kembali
                            </button>
                            <button onClick={() => window.print()} className="bg-indigo-600 text-white px-4 py-2 rounded shadow flex items-center gap-2">
                                <i className="fas fa-print"></i> Cetak Lembar Siswa
                            </button>
                        </div>

                        {/* Lembar Jawaban Siswa - Print Friendly */}
                        <div className="bg-white p-8 rounded-lg shadow print-container">
                            <div className="text-center mb-6 border-b pb-4">
                                <h1 className="text-2xl font-bold uppercase">{settings.appName}</h1>
                                <h2 className="text-xl font-bold uppercase">Lembar Hasil Ujian {selectedResult.category}</h2>
                                <p>Tahun Akademik: {selectedResult.academicYear}</p>
                            </div>
                            
                            <table className="w-full mb-6 text-sm">
                                <tbody>
                                    <tr><td className="font-bold w-32 py-1">Nama Siswa</td><td>: {selectedResult.studentName}</td></tr>
                                    <tr><td className="font-bold py-1">NIS</td><td>: {selectedResult.nim}</td></tr>
                                    <tr><td className="font-bold py-1">Mata Pelajaran</td><td>: {selectedResult.subject}</td></tr>
                                    <tr><td className="font-bold py-1">Kelas</td><td>: {selectedExam.className}</td></tr>
                                    <tr><td className="font-bold py-1">Nilai (PG)</td><td>: <span className="font-bold text-lg">{selectedResult.score}</span></td></tr>
                                </tbody>
                            </table>

                            <div className="space-y-4">
                                <h3 className="font-bold border-b pb-1 mb-3">Detail Jawaban</h3>
                                {selectedExam.questions.map((q, idx) => {
                                    const studentAns = selectedResult.essayAnswers[q.id] || selectedResult.essayAnswers[q.question]; // Compatibility
                                    // For PG, we might need to look into a different structure if we saved pg answers. 
                                    // Current implementation only saved essay answers in 'essayAnswers'. 
                                    // To make this fully work for PG review, we need to save all answers.
                                    // *Assuming future update saves all answers in a unified object, currently trying to display what's available*
                                    
                                    // NOTE: The previous ExamRunner implementation only passed `essayAnswers` for non-PG. 
                                    // To fully implement "Print Answers", we'd need to save PG answers too. 
                                    // For now, this will display Essay answers.
                                    
                                    return (
                                        <div key={q.id} className="mb-4 break-inside-avoid">
                                            <div className="flex gap-2">
                                                <span className="font-bold">{idx + 1}.</span>
                                                <div className="flex-1">
                                                    <p className="mb-1">{q.question}</p>
                                                    {q.type === 'multiple_choice' ? (
                                                        <div className="text-sm text-gray-600 ml-4">
                                                            <p>Tipe: Pilihan Ganda</p>
                                                            <p>Kunci Jawaban: <b>{q.correctAnswer}</b></p>
                                                            {/* If we had student answer for PG stored, we would show it here */}
                                                        </div>
                                                    ) : (
                                                        <div className="bg-gray-50 p-3 rounded border mt-2">
                                                            <p className="text-xs font-bold text-gray-500">Jawaban Siswa:</p>
                                                            <p>{studentAns || '-'}</p>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="space-in fade-in">
                    <div className="flex justify-between items-center mb-6 no-print">
                        <h2 className="text-2xl font-bold text-gray-800">Rekapitulasi {settings.currentAcademicYear}</h2>
                        <div className="flex gap-4">
                            <select className="border p-2 rounded bg-white" value={filterCategory} onChange={e => setFilterCategory(e.target.value)}>
                                <option value="all">Semua Kategori</option>
                                <option value="pts">PTS</option>
                                <option value="pas">PAS</option>
                            </select>
                            <button onClick={() => window.print()} className="bg-indigo-600 text-white px-4 py-2 rounded shadow flex items-center gap-2"><i className="fas fa-print"></i> Cetak Rekap</button>
                        </div>
                    </div>
                    <div className="print-only text-center mb-8">
                        <h1 className="text-2xl font-bold">LAPORAN HASIL UJIAN</h1>
                        <h2 className="text-xl">{settings.appName}</h2>
                        <p className="text-sm mt-2">Periode: {settings.currentAcademicYear} | Kategori: {filterCategory.toUpperCase()}</p>
                        <hr className="my-4 border-black" />
                    </div>
                    <div className="bg-white rounded-lg shadow border overflow-hidden print-container">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-indigo-50 text-indigo-900 uppercase">
                                <tr>
                                    <th className="p-3 border">Nama Siswa</th><th className="p-3 border">NIS</th><th className="p-3 border">Mapel</th>
                                    {!teacherFilter && <th className="p-3 border">Guru</th>}
                                    <th className="p-3 border">Nilai</th>
                                    <th className="p-3 border no-print">Aksi</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {filteredResults.map((res, i) => (
                                    <tr key={i} className="hover:bg-gray-50">
                                        <td className="p-3 border">{res.studentName}</td><td className="p-3 border">{res.nim}</td>
                                        <td className="p-3 border font-bold">{res.subject}</td>
                                        {!teacherFilter && <td className="p-3 border">{res.teacher}</td>}
                                        <td className="p-3 border font-bold text-green-600">{res.score}</td>
                                        <td className="p-3 border text-center no-print">
                                            <button 
                                                onClick={() => { setSelectedResult(res); setViewMode('detail'); }} 
                                                className="bg-blue-100 text-blue-700 px-3 py-1 rounded text-xs hover:bg-blue-200"
                                            >
                                                <i className="fas fa-eye"></i> Detail & Cetak
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- NEW: STUDENT EXAM UI (PERSISTENCE, PAGINATION, REVIEW, TIMER) ---
        const ExamRunner = ({ exam, student, onFinish, onCancel }) => {
            // Key unik untuk penyimpanan lokal berdasarkan ID ujian dan NIS siswa
            const storageKey = `smpn1_exam_${exam.id}_${student.nim}`;

            const [currentIdx, setCurrentIdx] = useState(() => {
                // Ambil nomor soal terakhir dari storage, default 0
                return parseInt(localStorage.getItem(`${storageKey}_idx`) || 0);
            });
            
            const [answers, setAnswers] = useState(() => {
                // Ambil jawaban tersimpan, default kosong
                return JSON.parse(localStorage.getItem(`${storageKey}_answers`) || '{}');
            });

            const [timeLeft, setTimeLeft] = useState(0);
            const [viewMode, setViewMode] = useState('question'); 

            useEffect(() => {
                // Hitung sisa waktu berdasarkan jam selesai absolut
                const now = new Date();
                const todayStr = now.toISOString().split('T')[0];
                const endTime = new Date(`${exam.date}T${exam.end}`);
                
                const diff = Math.max(0, Math.floor((endTime - now) / 1000));
                setTimeLeft(diff);

                const timer = setInterval(() => {
                    setTimeLeft(prev => {
                        if (prev <= 1) {
                            clearInterval(timer);
                            submitExam(true); // Auto submit jika waktu habis
                            return 0;
                        }
                        return prev - 1;
                    });
                }, 1000);

                return () => clearInterval(timer);
            }, []);

            // Simpan posisi soal setiap berubah
            useEffect(() => {
                localStorage.setItem(`${storageKey}_idx`, currentIdx);
            }, [currentIdx]);

            // Simpan jawaban setiap berubah
            useEffect(() => {
                localStorage.setItem(`${storageKey}_answers`, JSON.stringify(answers));
            }, [answers]);

            const formatTime = (seconds) => {
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = seconds % 60;
                return `${h}:${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
            };

            const handleAnswer = (val) => {
                setAnswers({ ...answers, [exam.questions[currentIdx].id]: val });
            };

            const submitExam = (auto = false) => {
                if(!auto && !confirm("Yakin ingin menyelesaikan ujian?")) return;
                let score = 0;
                let essayAnswers = {}; // We will store ALL answers here for detail view
                
                exam.questions.forEach(q => {
                    // Save answer for both types
                    essayAnswers[q.id] = answers[q.id] || '(Kosong)';

                    if (q.type === 'multiple_choice') {
                        if (answers[q.id] === q.correctAnswer) score += parseInt(q.points);
                    }
                });
                
                // Hapus data sementara setelah selesai
                localStorage.removeItem(`${storageKey}_idx`);
                localStorage.removeItem(`${storageKey}_answers`);
                
                onFinish(score, essayAnswers);
            };

            const currentQ = exam.questions[currentIdx];

            return (
                <div className="max-w-4xl mx-auto p-4 min-h-screen pb-20 fade-in bg-gray-100">
                    {/* Header */}
                    <div className="sticky top-4 z-30 bg-white p-4 rounded-xl shadow-lg border-b-4 border-yellow-500 mb-6 flex justify-between items-center">
                        <div>
                            <h2 className="font-bold text-lg">{exam.subject}</h2>
                            <p className="text-xs text-gray-500">{student.name} - {student.nim}</p>
                        </div>
                        <div className="text-right">
                            <div className="text-xs text-gray-500">Sisa Waktu</div>
                            <div className={`font-mono font-bold text-xl ${timeLeft < 300 ? 'text-red-600 animate-pulse' : 'text-blue-600'}`}>
                                {formatTime(timeLeft)}
                            </div>
                        </div>
                    </div>

                    {viewMode === 'question' && (
                        <div className="bg-white p-8 rounded-xl shadow-md min-h-[400px] flex flex-col justify-between">
                            <div>
                                <div className="flex justify-between mb-4">
                                    <span className="bg-blue-100 text-blue-800 font-bold px-3 py-1 rounded">Soal No. {currentIdx + 1}</span>
                                    <span className="text-gray-400 text-xs">Bobot: {currentQ.points}</span>
                                </div>
                                <p className="text-lg font-medium mb-6 leading-relaxed">{currentQ.question}</p>
                                
                                {currentQ.type === 'multiple_choice' ? (
                                    <div className="space-y-3">
                                        {currentQ.options.map((opt, i) => (
                                            <label key={i} className={`flex items-center p-4 rounded-lg border cursor-pointer transition ${answers[currentQ.id] === opt ? 'bg-blue-50 border-blue-500 ring-1 ring-blue-500' : 'hover:bg-gray-50 border-gray-200'}`}>
                                                <div className={`w-6 h-6 rounded-full border-2 mr-3 flex items-center justify-center ${answers[currentQ.id] === opt ? 'border-blue-500' : 'border-gray-300'}`}>
                                                    {answers[currentQ.id] === opt && <div className="w-3 h-3 bg-blue-500 rounded-full"></div>}
                                                </div>
                                                <input type="radio" name={`q-${currentQ.id}`} className="hidden" onChange={() => handleAnswer(opt)} checked={answers[currentQ.id] === opt} />
                                                <span className="text-gray-700">{opt}</span>
                                            </label>
                                        ))}
                                    </div>
                                ) : (
                                    <textarea className="w-full border p-4 rounded-lg focus:ring-2 focus:ring-blue-500" rows="6" placeholder="Ketik jawaban essay..." value={answers[currentQ.id] || ''} onChange={e => handleAnswer(e.target.value)}></textarea>
                                )}
                            </div>

                            <div className="flex justify-between mt-8 pt-6 border-t">
                                <button 
                                    onClick={() => setCurrentIdx(Math.max(0, currentIdx - 1))} 
                                    disabled={currentIdx === 0}
                                    className="px-6 py-2 rounded bg-gray-200 hover:bg-gray-300 disabled:opacity-50"
                                >
                                    <i className="fas fa-arrow-left"></i> Sebelumnya
                                </button>
                                
                                {currentIdx < exam.questions.length - 1 ? (
                                    <button 
                                        onClick={() => setCurrentIdx(currentIdx + 1)} 
                                        className="px-6 py-2 rounded bg-blue-600 text-white hover:bg-blue-700"
                                    >
                                        Selanjutnya <i className="fas fa-arrow-right"></i>
                                    </button>
                                ) : (
                                    <button 
                                        onClick={() => setViewMode('review')} 
                                        className="px-6 py-2 rounded bg-yellow-500 text-white hover:bg-yellow-600"
                                    >
                                        Selesai / Review <i className="fas fa-list"></i>
                                    </button>
                                )}
                            </div>
                        </div>
                    )}

                    {viewMode === 'review' && (
                        <div className="bg-white p-6 rounded-xl shadow-md">
                            <h3 className="font-bold text-xl mb-4 text-center">Review Jawaban</h3>
                            <div className="grid grid-cols-4 md:grid-cols-5 gap-4 mb-8">
                                {exam.questions.map((q, idx) => (
                                    <button 
                                        key={idx} 
                                        onClick={() => { setCurrentIdx(idx); setViewMode('question'); }}
                                        className={`p-4 rounded-lg border-2 font-bold text-lg ${answers[q.id] ? 'bg-green-500 text-white border-green-500' : 'bg-white text-gray-400 border-gray-200'}`}
                                    >
                                        {idx + 1}
                                    </button>
                                ))}
                            </div>
                            <div className="flex justify-center gap-4">
                                <button onClick={() => setViewMode('question')} className="px-6 py-3 rounded bg-gray-500 text-white">Kembali ke Soal</button>
                                <button onClick={() => submitExam(false)} className="px-8 py-3 rounded bg-green-600 text-white font-bold text-lg shadow-lg hover:bg-green-700">Kirim Jawaban (Selesai)</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- STUDENT DASHBOARD (MODIFIED WITH PERSISTENCE) ---
        const StudentDashboard = ({ user, setUser, students, setStudents, exams, results, setResults, handleLogout, settings }) => {
            // Kunci sesi spesifik user
            const sessionKey = `smpn1_student_session_${user.nim}`;

            // Inisialisasi state dari localStorage jika ada, agar tahan refresh
            const [activeScreen, setActiveScreen] = useState(() => localStorage.getItem(`${sessionKey}_screen`) || 'menu');
            const [selectedCategory, setSelectedCategory] = useState(() => localStorage.getItem(`${sessionKey}_cat`) || null);
            const [selectedExamId, setSelectedExamId] = useState(() => {
                const id = localStorage.getItem(`${sessionKey}_examId`);
                return id ? parseInt(id) : null;
            });

            // Simpan state ke localStorage setiap berubah
            useEffect(() => {
                localStorage.setItem(`${sessionKey}_screen`, activeScreen);
                if(selectedCategory) localStorage.setItem(`${sessionKey}_cat`, selectedCategory);
                else localStorage.removeItem(`${sessionKey}_cat`);
                
                if(selectedExamId) localStorage.setItem(`${sessionKey}_examId`, selectedExamId);
                else localStorage.removeItem(`${sessionKey}_examId`);
            }, [activeScreen, selectedCategory, selectedExamId]);

            // Logout khusus untuk membersihkan sesi
            const onLogout = () => {
                localStorage.removeItem(`${sessionKey}_screen`);
                localStorage.removeItem(`${sessionKey}_cat`);
                localStorage.removeItem(`${sessionKey}_examId`);
                handleLogout(); // Panggil logout global
            };

            const isExamDone = (examId) => results.some(r => r.nim === user.nim && r.examId === examId);

            const startExam = (exam) => {
                if(exam.questions.length === 0) return alert("Soal belum tersedia.");
                setSelectedExamId(exam.id);
                setActiveScreen('exam');
            };

            const onExamFinish = (score, essayAnswers) => {
                const currentExam = exams.find(e => e.id === selectedExamId);
                const resultData = {
                    examId: currentExam.id,
                    studentName: user.name,
                    nim: user.nim,
                    subject: currentExam.subject,
                    teacher: currentExam.teacher,
                    category: currentExam.category,
                    academicYear: currentExam.academicYear,
                    score: score,
                    essayAnswers: essayAnswers,
                    timestamp: new Date().toLocaleString()
                };
                setResults([...results, resultData]);
                alert(`Ujian Selesai! Skor Pilihan Ganda: ${score}`);
                setActiveScreen('category_list');
                setSelectedExamId(null);
            };

            const changePassword = () => {
                const newPass = prompt("Masukkan password baru:");
                if (!newPass) return;
                const updatedStudents = students.map(s => s.id === user.id ? { ...s, password: newPass } : s);
                setStudents(updatedStudents);
                setUser({ ...user, password: newPass });
                alert('Password berhasil diubah!');
            };

            const activeExamData = exams.find(e => e.id === selectedExamId);
            
            // Filter logic updated to include Class Check
            const filteredExams = exams.filter(e => {
                const matchCategory = e.category === selectedCategory;
                const matchYear = e.academicYear === settings.currentAcademicYear;
                // Match class or show if no class set (backward compatibility)
                const matchClass = e.className === user.className || !e.className; 
                return matchCategory && matchYear && matchClass;
            });

            if (activeScreen === 'menu') return (
                <div className="min-h-screen bg-gray-100 p-4">
                    <div className="max-w-5xl mx-auto space-y-6 fade-in">
                        <header className="bg-white p-6 rounded-xl shadow-sm flex justify-between items-center border-l-4 border-blue-600">
                            <div>
                                <h1 className="text-2xl font-bold text-gray-800">Halo, {user.name}</h1>
                                <p className="text-gray-500">{user.nim} | {user.className}</p>
                            </div>
                            <button onClick={onLogout} className="text-red-600 hover:bg-red-50 px-4 py-2 rounded">
                                <i className="fas fa-sign-out-alt"></i> Keluar
                            </button>
                        </header>
                        <div className="grid md:grid-cols-3 gap-6">
                            <div className="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div onClick={() => { setSelectedCategory('pts'); setActiveScreen('category_list'); }} className="bg-white p-6 rounded-xl shadow-md cursor-pointer hover:shadow-lg border-2 border-transparent transition group">
                                    <div className="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center mb-4"><i className="fas fa-file-alt text-orange-600 text-xl"></i></div>
                                    <h3 className="text-xl font-bold text-gray-800">PTS</h3>
                                    <p className="text-sm text-gray-500">Periode {settings.currentAcademicYear}</p>
                                </div>
                                <div onClick={() => { setSelectedCategory('pas'); setActiveScreen('category_list'); }} className="bg-white p-6 rounded-xl shadow-md cursor-pointer hover:shadow-lg border-2 border-transparent transition group">
                                    <div className="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mb-4"><i className="fas fa-graduation-cap text-purple-600 text-xl"></i></div>
                                    <h3 className="text-xl font-bold text-gray-800">PAS</h3>
                                    <p className="text-sm text-gray-500">Periode {settings.currentAcademicYear}</p>
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-xl shadow-sm">
                                <h3 className="font-bold text-gray-800 border-b pb-2 mb-3">Akun Saya</h3>
                                <button onClick={changePassword} className="w-full bg-slate-700 text-white px-4 py-2 rounded hover:bg-slate-800 mb-2">Ganti Password</button>
                            </div>
                        </div>
                    </div>
                </div>
            );

            if (activeScreen === 'category_list') return (
                <div className="min-h-screen bg-gray-100 p-4">
                    <div className="max-w-4xl mx-auto space-y-6 fade-in">
                        <header className="flex items-center gap-4 mb-6">
                            <button onClick={() => { setActiveScreen('menu'); setSelectedCategory(null); }} className="bg-white p-2 rounded-full shadow w-10 h-10 flex items-center justify-center"><i className="fas fa-arrow-left"></i></button>
                            <div><h1 className="text-2xl font-bold">Daftar Ujian {selectedCategory.toUpperCase()}</h1></div>
                        </header>
                        <div className="space-y-4">
                            {filteredExams.length === 0 ? <p className="text-center text-gray-500">Belum ada jadwal untuk kelas Anda.</p> : filteredExams.map(exam => (
                                <div key={exam.id} className="bg-white p-5 rounded-xl shadow-sm border hover:shadow-md transition">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <h4 className="font-bold text-lg text-blue-900">{exam.subject}</h4>
                                            <p className="text-sm text-gray-600">{exam.teacher}</p>
                                            <div className="text-xs text-gray-500 mt-2">{exam.date} | {exam.start} - {exam.end}</div>
                                        </div>
                                        <div>
                                            {isExamDone(exam.id) ? <span className="text-green-600 font-bold bg-green-50 px-3 py-1 rounded">Selesai</span> : 
                                            <button onClick={() => startExam(exam)} className="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-blue-700">Mulai</button>}
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );

            if (activeScreen === 'exam' && activeExamData) {
                return <ExamRunner exam={activeExamData} student={user} onFinish={onExamFinish} onCancel={() => setActiveScreen('category_list')} />;
            }
            // Fallback jika data ujian hilang (misal dihapus guru saat siswa sedang ujian)
            return <div className="p-10 text-center">Data ujian tidak ditemukan. <button onClick={() => setActiveScreen('menu')} className="text-blue-600 underline">Kembali</button></div>;
        };

        function ExamApp() {
            // --- STATE GLOBAL & STORAGE (PERSISTENCE) ---
            // Inisialisasi view dan user dari localStorage agar tahan refresh
            const [view, setView] = useState(() => localStorage.getItem('smpn1_app_view') || 'login'); 
            const [user, setUser] = useState(() => {
                const u = localStorage.getItem('smpn1_app_user');
                return u ? JSON.parse(u) : null;
            });
            
            // App Settings
            const [settings, setSettings] = useState(() => {
                const saved = localStorage.getItem('smpn1arahan_settings');
                return saved ? JSON.parse(saved) : DEFAULT_SETTINGS;
            });

            // Data Stores
            const [students, setStudents] = useState(() => {
                const saved = localStorage.getItem('smpn1arahan_students_v4');
                return saved ? JSON.parse(saved) : DEFAULT_STUDENTS;
            });
            const [teachers, setTeachers] = useState(() => {
                const saved = localStorage.getItem('smpn1arahan_teachers_v4');
                return saved ? JSON.parse(saved) : DEFAULT_TEACHERS;
            });
            const [subjects, setSubjects] = useState(() => {
                const saved = localStorage.getItem('smpn1arahan_subjects_v4');
                return saved ? JSON.parse(saved) : DEFAULT_SUBJECTS;
            });
            const [exams, setExams] = useState(() => {
                const saved = localStorage.getItem('smpn1arahan_exams_v4');
                return saved ? JSON.parse(saved) : DEFAULT_EXAMS;
            });
            const [results, setResults] = useState(() => {
                const saved = localStorage.getItem('smpn1arahan_results_v4');
                return saved ? JSON.parse(saved) : [];
            });
            
            const [adminCreds] = useState({ username: 'admin', password: 'arkan@yumna' });
            const [loginInput, setLoginInput] = useState({ username: '', password: '' });

            // --- EFFECT: SAVE SESSION & DATA ---
            useEffect(() => {
                localStorage.setItem('smpn1_app_view', view);
                if(user) localStorage.setItem('smpn1_app_user', JSON.stringify(user));
                else localStorage.removeItem('smpn1_app_user');
            }, [view, user]);

            useEffect(() => { localStorage.setItem('smpn1arahan_settings', JSON.stringify(settings)); }, [settings]);
            useEffect(() => { localStorage.setItem('smpn1arahan_students_v4', JSON.stringify(students)); }, [students]);
            useEffect(() => { localStorage.setItem('smpn1arahan_teachers_v4', JSON.stringify(teachers)); }, [teachers]);
            useEffect(() => { localStorage.setItem('smpn1arahan_subjects_v4', JSON.stringify(subjects)); }, [subjects]);
            useEffect(() => { localStorage.setItem('smpn1arahan_exams_v4', JSON.stringify(exams)); }, [exams]);
            useEffect(() => { localStorage.setItem('smpn1arahan_results_v4', JSON.stringify(results)); }, [results]);

            // --- AUTH ---
            const handleLogin = (e) => {
                e.preventDefault();
                const { username, password } = loginInput;

                if (username === adminCreds.username && password === adminCreds.password) {
                    setUser({ role: 'admin', name: 'Administrator' });
                    setView('adminDashboard');
                    return;
                }
                
                const teacher = teachers.find(t => t.username === username && t.password === password);
                if (teacher) {
                    setUser({ role: 'teacher', ...teacher });
                    setView('teacherDashboard');
                    return;
                }

                const student = students.find(s => s.username === username && s.password === password);
                if (student) {
                    setUser({ role: 'student', ...student });
                    setView('studentDashboard');
                    return;
                }

                alert('Username atau Password salah!');
            };

            const handleLogout = () => {
                setUser(null);
                setLoginInput({ username: '', password: '' });
                setView('login');
                // Hapus sesi global saat logout eksplisit
                localStorage.removeItem('smpn1_app_view');
                localStorage.removeItem('smpn1_app_user');
            };

            return (
                <div>
                    {view === 'login' && <LoginView handleLogin={handleLogin} loginInput={loginInput} setLoginInput={setLoginInput} settings={settings} />}
                    {view === 'adminDashboard' && (
                        <AdminDashboard 
                            students={students} setStudents={setStudents}
                            teachers={teachers} setTeachers={setTeachers}
                            subjects={subjects} setSubjects={setSubjects}
                            exams={exams} setExams={setExams}
                            results={results} handleLogout={handleLogout}
                            settings={settings} setSettings={setSettings}
                        />
                    )}
                    {view === 'teacherDashboard' && (
                        <TeacherDashboard 
                            user={user} setUser={setUser}
                            teachers={teachers} setTeachers={setTeachers}
                            exams={exams} setExams={setExams}
                            results={results} handleLogout={handleLogout}
                            settings={settings}
                        />
                    )}
                    {view === 'studentDashboard' && (
                        <StudentDashboard 
                            user={user} setUser={setUser}
                            students={students} setStudents={setStudents}
                            exams={exams}
                            results={results} setResults={setResults}
                            handleLogout={handleLogout}
                            settings={settings}
                        />
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ExamApp />);
    </script>
</body>
</html>
